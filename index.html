<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft Work Order System - Debug</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0a4d8c;
            --accent: #ff6b35;
            --success: #00a86b;
            --warning: #ffa500;
            --danger: #dc3545;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #063a6a 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .container { max-width: 1900px; margin: 0 auto; padding: 2rem; }
        .btn { padding: 0.6rem 1.4rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .debug-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 1rem; }
        th { background: var(--primary); color: white; padding: 1rem; text-align: left; font-size: 0.85rem; }
        td { padding: 1rem; border-bottom: 1px solid #e1e8ed; font-size: 0.9rem; }
        tr:hover { background: #f0f4f8; }
        
        .due-info {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
        }
        
        .due-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
            text-transform: uppercase;
        }
        
        .badge-date {
            background: rgba(10, 77, 140, 0.1);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        
        .badge-hours {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: 1px solid #2563eb;
        }
        
        .badge-cycles {
            background: rgba(124, 58, 237, 0.1);
            color: #7c3aed;
            border: 1px solid #7c3aed;
        }
        
        .critical { color: var(--danger); font-weight: 700; }
        .warning-level { color: var(--warning); font-weight: 600; }
        .status-pending { color: var(--warning); font-weight: bold; }
        .status-completed { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚úà Aircraft Work Order System - DEBUG MODE</h1>
    </div>
    <div class="container">
        <button class="btn btn-primary" onclick="loadFromSheet()" id="refreshBtn">üîÑ Refresh</button>
        <button class="btn btn-success" onclick="toggleDebug()" id="debugBtn">üêõ Show Debug</button>
        
        <div id="debugPanel" class="debug-panel" style="display: none;">
            <strong>Debug Console:</strong>
            <div id="debugLog"></div>
        </div>
        
        <table id="workOrderTable">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Aircraft</th>
                    <th>W/O Number</th>
                    <th>Description</th>
                    <th>Due Information (Raw)</th>
                    <th>Due Information (Parsed)</th>
                    <th>Action Plan (Raw)</th>
                    <th>Remaining</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="9" style="text-align: center; padding: 2rem;">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXiRXaJISr4tcW13tBxLXI7heUjDbCyGyyABHPZIrx-m2YqXWP0oyeTw1VL4slZ0dJrrngl3CsvO2z/pub?gid=1269716757&single=true&output=csv';
        
        let workOrders = [];
        let debugLogs = [];
        
        function debugLog(message) {
            console.log(message);
            debugLogs.push(message);
            const debugDiv = document.getElementById('debugLog');
            if (debugDiv) {
                debugDiv.innerHTML = debugLogs.join('<br>');
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }
        
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        async function loadFromSheet() {
            debugLogs = [];
            debugLog('=== LOADING DATA ===');
            
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥ Loading...';
            
            try {
                debugLog('Fetching CSV from: ' + SHEET_URL);
                const response = await fetch(SHEET_URL);
                const csv = await response.text();
                
                debugLog('CSV received, length: ' + csv.length);
                debugLog('First 200 chars: ' + csv.substring(0, 200));
                
                workOrders = parseCSV(csv);
                debugLog('Parsed ' + workOrders.length + ' work orders');
                
                renderTable();
            } catch (error) {
                debugLog('ERROR: ' + error.message);
                console.error('Error loading sheet:', error);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh';
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const orders = [];
            
            debugLog('--- CSV PARSING ---');
            debugLog('Total lines: ' + lines.length);
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                debugLog(`\nLine ${i}: ${line.substring(0, 100)}...`);
                
                // Handle quoted fields
                const fields = [];
                let currentField = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                fields.push(currentField.trim());
                
                if (fields.length < 6) {
                    debugLog(`  Skipped - only ${fields.length} fields`);
                    continue;
                }
                
                debugLog(`  Fields[0] (Aircraft): "${fields[0]}"`);
                debugLog(`  Fields[1] (WO): "${fields[1]}"`);
                debugLog(`  Fields[2] (Desc): "${fields[2].substring(0, 50)}..."`);
                debugLog(`  Fields[3] (Due): "${fields[3]}"`);
                debugLog(`  Fields[4] (Remarks): "${fields[4]}"`);
                debugLog(`  Fields[5] (Action): "${fields[5]}"`);
                
                const dueInfo = parseDueDate(fields[3], fields[5]);
                debugLog(`  Parsed Due Info:`, dueInfo);
                
                orders.push({
                    aircraft: fields[0] || '',
                    woNumber: fields[1] || '',
                    description: fields[2] || '',
                    dueDateRaw: fields[3] || '',
                    actionPlanRaw: fields[5] || '',
                    dueInfo: dueInfo,
                    remarks: fields[4] || '',
                    actionPlan: fields[5] || '',
                    status: fields[6] || 'Pending',
                    completedBy: fields[7] || '',
                    completedDate: fields[8] || '',
                    logbookUrl: fields[9] || '',
                    completionNotes: fields[10] || ''
                });
            }
            
            return orders;
        }
        
        function parseDueDate(dueDateField, actionPlanField) {
            debugLog(`    parseDueDate called:`);
            debugLog(`      dueDateField: "${dueDateField}"`);
            debugLog(`      actionPlanField: "${actionPlanField}"`);
            
            // Combine both fields for parsing
            const combinedText = dueDateField + '\n' + (actionPlanField || '');
            debugLog(`      combinedText: "${combinedText}"`);
            
            const result = {
                type: [],
                date: null,
                hours: null,
                cycles: null,
                remaining: {
                    hours: null,
                    cycles: null,
                    text: ''
                }
            };
            
            // Check for date
            const dateMatch = combinedText.match(/(\d{1,2})-([A-Za-z]{3})-(\d{2,4})/);
            if (dateMatch) {
                result.type.push('date');
                result.date = dateMatch[0];
                debugLog(`      Found DATE: ${result.date}`);
            }
            
            // Check for hours - more flexible patterns
            const hoursPatterns = [
                /(\d+):(\d+)\s*(?:\(?\s*AFH\s*\)?)?/gi,
                /(\d+)\s*hrs?\s*(?:\(?\s*AFH\s*\)?)?/gi
            ];
            
            for (const pattern of hoursPatterns) {
                const hoursMatch = combinedText.match(pattern);
                if (hoursMatch && hoursMatch[0].includes(':')) {
                    const match = hoursMatch[0].match(/(\d+):(\d+)/);
                    if (match) {
                        result.type.push('hours');
                        result.hours = `${match[1]}:${match[2]}`;
                        debugLog(`      Found HOURS: ${result.hours}`);
                        break;
                    }
                }
            }
            
            // Check for cycles - more flexible
            const cyclesPatterns = [
                /(\d+)\s*(?:\(?\s*AFL\s*\)?)/gi,
                /(\d+)\s*(?:\(?\s*AFC\s*\)?)/gi,
                /(\d+)\s*cycles?/gi
            ];
            
            for (const pattern of cyclesPatterns) {
                const cyclesMatch = combinedText.match(pattern);
                if (cyclesMatch) {
                    const match = cyclesMatch[0].match(/(\d+)/);
                    if (match) {
                        result.type.push('cycles');
                        result.cycles = match[1];
                        debugLog(`      Found CYCLES: ${result.cycles}`);
                        break;
                    }
                }
            }
            
            // Check for remaining hours
            const remainingHoursMatch = combinedText.match(/(\d+)\s*AFH\s*REMAINING/i);
            if (remainingHoursMatch) {
                result.remaining.hours = remainingHoursMatch[1];
                debugLog(`      Found REMAINING HOURS: ${result.remaining.hours}`);
            }
            
            // Check for remaining cycles
            const remainingCyclesMatch = combinedText.match(/(\d+)\s*AF[LC]\s*REMAINING/i);
            if (remainingCyclesMatch) {
                result.remaining.cycles = remainingCyclesMatch[1];
                debugLog(`      Found REMAINING CYCLES: ${result.remaining.cycles}`);
            }
            
            // Get "as of" date
            const asOfMatch = combinedText.match(/AS OF\s+(\d+-[A-Za-z]{3}-\d{2,4})/i);
            if (asOfMatch) {
                result.remaining.text = `as of ${asOfMatch[1]}`;
                debugLog(`      Found AS OF: ${result.remaining.text}`);
            }
            
            debugLog(`      Final result:`, JSON.stringify(result));
            return result;
        }
        
        function formatDueInfo(dueInfo) {
            if (!dueInfo.type || dueInfo.type.length === 0) {
                return '<em>No parsed info</em>';
            }
            
            let html = '<div class="due-info">';
            
            if (dueInfo.type.includes('date') && dueInfo.date) {
                html += `<div><span class="due-type-badge badge-date">Date</span>${dueInfo.date}</div>`;
            }
            
            if (dueInfo.type.includes('hours') && dueInfo.hours) {
                html += `<div><span class="due-type-badge badge-hours">AFH</span>${dueInfo.hours} hrs</div>`;
            }
            
            if (dueInfo.type.includes('cycles') && dueInfo.cycles) {
                html += `<div><span class="due-type-badge badge-cycles">AFL</span>${dueInfo.cycles} cycles</div>`;
            }
            
            html += '</div>';
            return html;
        }
        
        function formatRemaining(dueInfo) {
            if (!dueInfo.remaining) return '-';
            
            let html = '<div class="due-info">';
            let hasRemaining = false;
            
            if (dueInfo.remaining.hours !== null) {
                const hours = parseInt(dueInfo.remaining.hours);
                const className = hours <= 10 ? 'critical' : hours <= 30 ? 'warning-level' : '';
                html += `<div class="${className}">${hours} AFH remaining</div>`;
                hasRemaining = true;
            }
            
            if (dueInfo.remaining.cycles !== null) {
                const cycles = parseInt(dueInfo.remaining.cycles);
                const className = cycles <= 5 ? 'critical' : cycles <= 15 ? 'warning-level' : '';
                html += `<div class="${className}">${cycles} AFL remaining</div>`;
                hasRemaining = true;
            }
            
            if (dueInfo.remaining.text) {
                html += `<div style="font-size: 0.8rem; color: #666; font-style: italic;">${dueInfo.remaining.text}</div>`;
                hasRemaining = true;
            }
            
            html += '</div>';
            return hasRemaining ? html : '-';
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (workOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No work orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = workOrders.map((wo, i) => `
                <tr>
                    <td><span class="status-${wo.status.toLowerCase()}">${wo.status}</span></td>
                    <td><strong>${wo.aircraft}</strong></td>
                    <td>${wo.woNumber}</td>
                    <td style="max-width: 200px; white-space: pre-wrap; font-size: 0.8rem;">${wo.description}</td>
                    <td style="max-width: 150px; white-space: pre-wrap; font-size: 0.8rem; background: #f9f9f9;">${wo.dueDateRaw}</td>
                    <td>${formatDueInfo(wo.dueInfo)}</td>
                    <td style="max-width: 150px; white-space: pre-wrap; font-size: 0.8rem; background: #f9f9f9;">${wo.actionPlanRaw}</td>
                    <td>${formatRemaining(wo.dueInfo)}</td>
                    <td>
                        ${wo.status !== 'Completed' ? 
                            `<button class="btn btn-success">Complete</button>` : 
                            'Completed'
                        }
                    </td>
                </tr>
            `).join('');
        }
        
        loadFromSheet();
    </script>
</body>
</html>
