<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fleet Command | Real-Time Aircraft Status (Vanilla)</title>

  <!-- Keep CSP compatible with GitHub Pages + proxy CSV fetch -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https:; 
                 script-src 'self' https: 'unsafe-inline' https://cdn.tailwindcss.com https://api.allorigins.win https://corsproxy.io; 
                 style-src 'self' https: 'unsafe-inline'; 
                 img-src 'self' https: data:; 
                 connect-src 'self' https: https://api.allorigins.win https://corsproxy.io;">

  <!-- Tailwind CDN for fast styling (optional, but matches your original approach) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --status-serviceable: #10b981;
      --status-mro: #f59e0b;
      --status-aog: #ef4444;
      --status-default: #64748b;
    }

    * { scrollbar-width: thin; scrollbar-color: rgba(56, 189, 248, 0.3) transparent; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb {
      background: rgba(56, 189, 248, 0.35);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(56, 189, 248, 0.6); }

    body{
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #0a0f1d;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.08) 0%, transparent 25%),
        radial-gradient(circle at 90% 80%, rgba(6, 182, 212, 0.08) 0%, transparent 25%),
        linear-gradient(to bottom, #0a0f1d 0%, #070b16 100%);
      color: #e2e8f0;
      overflow-x: hidden;
      background-attachment: fixed;
      margin: 0;
      padding-top: 2.5rem;
    }

    .gradient-border{ position:relative; border-radius:inherit; }
    .gradient-border::before{
      content:'';
      position:absolute; inset:0; padding:1.5px;
      background: linear-gradient(120deg, #38bdf8, #8b5cf6, #22d3ee, #38bdf8);
      background-size: 300% 300%;
      border-radius: inherit;
      animation: gradient-x 15s ease infinite alternate;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }
    @keyframes gradient-x{
      0%{ background-position:0% 50%; }
      100%{ background-position:100% 50%; }
    }

    .card-glow{ position:relative; overflow:hidden; transition: all .35s ease; border:1px solid rgba(255,255,255,.08); }
    .card-glow::after{
      content:'';
      position:absolute; top:-50%; left:-50%;
      width:200%; height:200%;
      background: radial-gradient(circle, rgba(56,189,248,.15) 0%, transparent 70%);
      opacity:0; transition: opacity .45s ease;
      pointer-events:none; z-index:0;
    }
    .card-glow:hover::after{ opacity:1; }
    .card-content{ position:relative; z-index:1; }

    .status-bar{
      height:4px; border-radius:2px 2px 0 0;
      background: linear-gradient(90deg, var(--status-color), transparent);
      position:absolute; top:0; left:0; right:0;
      animation: status-pulse 2s ease-in-out infinite;
    }
    @keyframes status-pulse{
      0%,100%{ opacity:1; transform:scale(1); }
      50%{ opacity:.82; transform:scale(1.03); }
    }

    .status-dot{
      display:inline-block;
      width:10px; height:10px; border-radius:50%;
      margin-right:6px; flex-shrink:0;
      box-shadow:0 0 0 2px currentColor;
    }
    .status-serviceable{ background-color: var(--status-serviceable); }
    .status-mro{ background-color: var(--status-mro); }
    .status-aog{ background-color: var(--status-aog); animation: blink 1.5s ease-in-out infinite; }
    .status-default{ background-color: var(--status-default); }

    @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:.5} }

    .table-header-sticky{
      position: sticky;
      top: 2.5rem;
      z-index: 20;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.85);
      box-shadow: 0 4px 20px rgba(0,0,0,.35);
    }

    @media (max-width: 768px){
      body{ padding-top: 3.5rem; }
      .table-header-sticky{ top: 3.5rem; }
      .mobile-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
      .min-w-table{ min-width: 900px; }
    }
  </style>

  <script>
    // Same proxy fetch strategy as your original file [Source](https://www.genspark.ai/api/files/s/IRVVsDaT)
    window.fetchGoogleSheet = async (url) => {
      const proxies = [
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        `https://corsproxy.io/?${encodeURIComponent(url)}`
      ];

      for (const proxy of proxies) {
        try {
          const res = await fetch(proxy, { mode: 'cors' });
          if (res.ok) return await res.text();
        } catch (e) {
          console.warn(`Proxy failed: ${proxy}`, e);
        }
      }

      console.error("All data sources failed. Using demo data.");
      return `Sl No,Registration,Type,Status,Daily Insp,Weekly Insp,MEL,Remarks
1,VT-ABC,A320,SERVICEABLE,25/01/2026 14:30,01/02/2026 09:00,,Normal
2,VT-XYZ,B737,MRO,20/01/2026 10:00,28/01/2026 16:00,Hydraulic leak,Under maintenance
3,VT-DEF,A321,AOG,18/01/2026 08:00,25/01/2026 11:00,Engine fault,Critical repair
4,VT-GHI,E190,SERVICEABLE,26/01/2026 16:45,02/02/2026 10:30,,Normal
5,VT-JKL,A320,MRO,19/01/2026 11:20,27/01/2026 14:15,Auxiliary power unit,Scheduled maintenance`;
    };
  </script>
</head>

<body class="min-h-screen">
  <!-- SYSTEM STATUS BAR -->
  <div id="sysbar" class="fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-slate-950 to-slate-900 border-b border-blue-500/20 backdrop-blur-sm" role="status" aria-live="polite">
    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-10">
        <div class="flex items-center gap-2">
          <div id="sysdot" class="w-2 h-2 rounded-full bg-amber-500"></div>
          <span id="sysmsg" class="text-xs font-mono font-bold tracking-wider text-slate-300">SYSTEM INITIALIZING</span>
        </div>
        <div id="lastsync" class="text-xs font-mono text-slate-400">Awaiting first sync...</div>
      </div>
    </div>
  </div>

  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
    <!-- HEADER -->
    <div class="pt-14 pb-8">
      <div class="gradient-border rounded-3xl overflow-hidden">
        <div class="bg-gradient-to-br from-slate-950 to-slate-900 p-6 md:p-8 relative overflow-hidden">
          <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl -mr-24 -mt-24"></div>
          <div class="absolute bottom-0 left-0 w-80 h-80 bg-cyan-500/10 rounded-full blur-3xl -ml-20 -mb-20"></div>

          <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
            <div class="flex items-center gap-5">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-cyan-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30 border border-white/20">
                <span class="text-2xl font-black">✈</span>
              </div>
              <div>
                <h1 class="text-3xl md:text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-300 to-cyan-300 tracking-tight">
                  FLEET COMMAND
                </h1>
                <p class="text-slate-300 font-medium text-base mt-1 flex items-center gap-2.5">
                  <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                  Real-Time Aircraft Status & Maintenance Dashboard
                </p>
              </div>
            </div>

            <div class="text-right">
              <div class="text-xs font-bold text-blue-200 uppercase tracking-widest mb-1.5">SYSTEM TIME (UTC)</div>
              <div id="utcClock" class="font-mono text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-400">
                00:00:00
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-7">
      <div class="gradient-border rounded-xl overflow-hidden">
        <div class="bg-slate-900/50 backdrop-blur-sm p-1.5 flex flex-wrap gap-1.5" id="statusFilters">
          <!-- buttons injected -->
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <div class="gradient-border rounded-lg overflow-hidden">
          <div class="bg-slate-900/50 backdrop-blur-sm p-1 flex">
            <button id="btnGrid" class="p-2.5 rounded-md bg-blue-500/20 text-cyan-300 shadow-lg shadow-blue-500/20" title="Grid View">▦</button>
            <button id="btnTable" class="p-2.5 rounded-md text-slate-400 hover:text-slate-200 hover:bg-slate-800/70" title="Table View">≡</button>
          </div>
        </div>

        <button id="btnSync"
          class="px-4 py-2.5 rounded-xl font-bold text-sm bg-blue-500/20 text-blue-200 border border-blue-500/40 hover:bg-blue-500/30 transition">
          Sync Now
        </button>

        <div class="gradient-border rounded-xl overflow-hidden">
          <div class="bg-slate-900/50 backdrop-blur-sm px-4 py-2.5 flex items-center gap-3">
            <div class="text-xs text-slate-400 font-mono">Next Sync</div>
            <div id="countdown" class="text-sm font-black text-cyan-300 font-mono">300s</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ERROR BANNER -->
    <div id="errorBanner" class="hidden mb-6 p-4 rounded-xl bg-rose-500/10 border-l-4 border-rose-500 text-slate-200">
      <div class="font-bold">Data Error</div>
      <div id="errorMsg" class="text-sm text-rose-200 mt-1"></div>
    </div>

    <!-- CONTENT -->
    <div id="content"></div>

    <!-- FOOTER -->
    <div class="mt-10 mb-10 text-center text-xs text-slate-500 font-mono">
      Fleet Command (Vanilla JS build) • Data Source: Google Sheets CSV • Auto-refresh: 300s
    </div>
  </div>

<script>
  // ===== Config from original file requirements [Source](https://www.genspark.ai/api/files/s/IRVVsDaT)
  const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSXiRXaJISr4tcW13tBxLXI7heUjDbCyGyyABHPZIrx-m2YqXWP0oyeTw1VL4slZ0dJrrngl3CsvO2z/pub?gid=0&single=true&output=csv';
  const REFRESH_SECONDS = 300;
  const SHOW_HOURS_THRESHOLD = 24;

  const STATUS_CONFIG = {
    ALL: { label: 'All Fleet', dotClass: 'status-default', border: 'border-blue-500/40', bg: 'bg-blue-500/20', text: 'text-blue-300' },
    SERVICEABLE: { label: 'Serviceable', color: 'var(--status-serviceable)', bgCard: 'bg-[#0f2922]/50', borderCard: 'border-[#10b981]/30', text: 'text-emerald-300', dotClass: 'status-serviceable' },
    MRO: { label: 'Under Maintenance', color: 'var(--status-mro)', bgCard: 'bg-[#2c1e0a]/50', borderCard: 'border-[#f59e0b]/30', text: 'text-amber-300', dotClass: 'status-mro' },
    AOG: { label: 'Aircraft on Ground', color: 'var(--status-aog)', bgCard: 'bg-[#2a0a0f]/50', borderCard: 'border-[#ef4444]/30', text: 'text-rose-300', dotClass: 'status-aog' },
    DEFAULT: { label: 'Unknown Status', color: 'var(--status-default)', bgCard: 'bg-slate-900/40', borderCard: 'border-slate-700', text: 'text-slate-400', dotClass: 'status-default' }
  };

  // ===== State
  let aircraft = [];
  let filterStatus = 'ALL';
  let viewMode = 'grid';
  let syncing = false;
  let nextSync = REFRESH_SECONDS;
  let lastSyncTime = null;
  let systemStatus = 'initializing';
  let dataError = null;

  // ===== DOM
  const sysdot = document.getElementById('sysdot');
  const sysmsg = document.getElementById('sysmsg');
  const lastsync = document.getElementById('lastsync');
  const utcClock = document.getElementById('utcClock');
  const statusFilters = document.getElementById('statusFilters');
  const btnGrid = document.getElementById('btnGrid');
  const btnTable = document.getElementById('btnTable');
  const btnSync = document.getElementById('btnSync');
  const countdown = document.getElementById('countdown');
  const content = document.getElementById('content');
  const errorBanner = document.getElementById('errorBanner');
  const errorMsg = document.getElementById('errorMsg');

  function setSystem(status, message) {
    systemStatus = status;
    sysmsg.textContent = message;

    sysdot.className = 'w-2 h-2 rounded-full ' + (
      status === 'operational' ? 'bg-emerald-500 animate-pulse' :
      status === 'syncing' ? 'bg-blue-500 animate-pulse' :
      status === 'error' ? 'bg-rose-500' : 'bg-amber-500'
    );
  }

  function setError(errText) {
    dataError = errText || null;
    if (dataError) {
      errorBanner.classList.remove('hidden');
      errorMsg.textContent = dataError;
      setSystem('error', `DATA ERROR: ${dataError.substring(0, 42)}`);
    } else {
      errorBanner.classList.add('hidden');
      errorMsg.textContent = '';
    }
  }

  function updateLastSync() {
    if (!lastSyncTime) {
      lastsync.textContent = 'Awaiting first sync...';
      return;
    }
    lastsync.textContent = `Last Updated: ${lastSyncTime.toLocaleTimeString('en-GB', {
      hour: '2-digit', minute: '2-digit', hour12: false
    })} UTC`;
  }

  function pad2(n){ return String(n).padStart(2,'0'); }

  function tickClock() {
    const now = new Date();
    utcClock.textContent = `${pad2(now.getUTCHours())}:${pad2(now.getUTCMinutes())}:${pad2(now.getUTCSeconds())}`;
  }

  // Keep your original time logic concept (remaining vs overdue) [Source](https://www.genspark.ai/api/files/s/IRVVsDaT)
  function calculateTime(dateStr) {
    if (!dateStr || !dateStr.trim()) return { hours: 999, overdue: false, display: '' };
    try {
      const cleanStr = dateStr.replace(/\s+/g,' ').trim();
      const parts = cleanStr.split(' ');
      if (parts.length < 2) return { hours: 999, overdue: false, display: dateStr };

      const datePart = parts[0].split('/');
      const timePart = parts[1].split(':');
      if (datePart.length < 3 || timePart.length < 2) return { hours: 999, overdue: false, display: dateStr };

      const due = new Date(Date.UTC(
        parseInt(datePart[2],10),
        parseInt(datePart[1],10) - 1,
        parseInt(datePart[0],10),
        parseInt(timePart[0],10),
        parseInt(timePart[1],10)
      ));

      const now = new Date();
      const diffMs = due - now;
      const totalHours = diffMs / 3600000;
      const hours = Math.floor(totalHours);
      const minutes = Math.floor((totalHours - hours) * 60);

      if (diffMs < 0) {
        const overdueHours = Math.abs(hours);
        return { hours: -overdueHours, overdue: true, display: `OVERDUE ${overdueHours}h ${Math.abs(minutes)}m` };
      }
      return { hours, overdue: false, display: `${hours}h ${minutes}m remaining` };
    } catch (e) {
      return { hours: 999, overdue: false, display: dateStr };
    }
  }

  function getAlertType(ac) {
    const daily = calculateTime(ac.dailyInsp);
    const weekly = calculateTime(ac.weeklyInsp);
    const isCritical = (daily.hours <= 3 && !daily.overdue) || (weekly.hours <= 3 && !weekly.overdue);

    if (daily.overdue || weekly.overdue) return { kind: 'CRITICAL', label: 'INSPECTION OVERDUE' };
    if (isCritical) return { kind: 'WARNING', label: 'DUE SOON' };

    const statusKey = (ac.status || 'DEFAULT').toUpperCase();
    const remarks = (ac.remarks || '').trim();
    if (statusKey === 'SERVICEABLE' && (!remarks || remarks.toUpperCase() === 'NORMAL')) {
      return { kind: 'READY', label: 'Ready for Dispatch' };
    }
    if (remarks) return { kind: 'INFO', label: remarks };
    return { kind: 'DEFAULT', label: 'No alerts' };
  }

  // Basic CSV parser (still simple; avoids React dependency)
  // Note: Still won’t fully support quoted commas; can be enhanced if needed.
  function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) throw new Error('Invalid data format');

    return lines.slice(1).map(line => {
      const cols = line.split(',').map(c => c.trim().replace(/"/g,''));
      return {
        slNo: parseInt(cols[0],10) || 0,
        registration: cols[1] || 'UNKNOWN',
        type: cols[2] || 'N/A',
        status: (cols[3] || 'DEFAULT').toUpperCase(),
        dailyInsp: cols[4] || '',
        weeklyInsp: cols[5] || '',
        mel: cols[6] || '',
        remarks: cols[7] || ''
      };
    }).filter(r => r.registration !== 'UNKNOWN' && r.slNo > 0);
  }

  function filteredList() {
    if (filterStatus === 'ALL') return aircraft;
    return aircraft.filter(a => (a.status || '').toUpperCase() === filterStatus);
  }

  function buildFilters() {
    const statuses = ['ALL','SERVICEABLE','MRO','AOG'];
    statusFilters.innerHTML = '';
    statuses.forEach(st => {
      const isActive = (filterStatus === st);
      const cfg = STATUS_CONFIG[st] || STATUS_CONFIG.DEFAULT;

      const btn = document.createElement('button');
      btn.className =
        `px-4 py-2.5 rounded-lg text-sm font-bold transition-all duration-300 whitespace-nowrap relative overflow-hidden ` +
        (isActive
          ? `${cfg.bg || 'bg-blue-500/20'} ${cfg.text || 'text-blue-300'} border ${cfg.border || 'border-blue-500/40'} shadow-lg shadow-blue-500/20`
          : `text-slate-300 hover:text-white hover:bg-slate-800/70`);
      btn.textContent = cfg.label || st;
      btn.onclick = () => { filterStatus = st; buildFilters(); render(); };
      statusFilters.appendChild(btn);
    });
  }

  function setView(mode) {
    viewMode = mode;
    if (mode === 'grid') {
      btnGrid.className = "p-2.5 rounded-md bg-blue-500/20 text-cyan-300 shadow-lg shadow-blue-500/20";
      btnTable.className = "p-2.5 rounded-md text-slate-400 hover:text-slate-200 hover:bg-slate-800/70";
    } else {
      btnTable.className = "p-2.5 rounded-md bg-blue-500/20 text-cyan-300 shadow-lg shadow-blue-500/20";
      btnGrid.className = "p-2.5 rounded-md text-slate-400 hover:text-slate-200 hover:bg-slate-800/70";
    }
    render();
  }

  function melChips(mel) {
    const clean = (mel || '').trim();
    if (!clean) {
      return `<span class="text-emerald-400 font-bold bg-emerald-500/10 px-2.5 py-1 rounded border border-emerald-500/20 text-xs">NIL</span>`;
    }
    return clean.split(';').map(item => `
      <span class="text-rose-300 font-bold bg-rose-500/10 px-2.5 py-1 rounded border border-rose-500/20 text-xs">
        ${escapeHtml(item.trim())}
      </span>
    `).join('');
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function cardHTML(ac) {
    const statusKey = (ac.status || 'DEFAULT').toUpperCase();
    const cfg = STATUS_CONFIG[statusKey] || STATUS_CONFIG.DEFAULT;
    const daily = calculateTime(ac.dailyInsp);
    const weekly = calculateTime(ac.weeklyInsp);
    const alert = getAlertType(ac);

    const alertHTML = (() => {
      if (alert.kind === 'CRITICAL') return `<span class="flex items-center gap-1.5 text-rose-400 font-bold text-sm">⚠ ${escapeHtml(alert.label)}</span>`;
      if (alert.kind === 'WARNING') return `<span class="flex items-center gap-1.5 text-amber-400 font-bold text-sm">⚠ ${escapeHtml(alert.label)}</span>`;
      if (alert.kind === 'READY') return `<span class="flex items-center gap-1.5 text-emerald-400 font-bold text-sm">✓ ${escapeHtml(alert.label)}</span>`;
      if (alert.kind === 'INFO') return `<span class="text-slate-300 font-medium text-sm max-w-[200px] truncate" title="${escapeHtml(alert.label)}">${escapeHtml(alert.label)}</span>`;
      return `<span class="text-slate-500 text-sm">No alerts</span>`;
    })();

    const dueLine = (t) => {
      if (t.hours === 999) return '';
      if (t.overdue) return `<div class="text-xs font-bold mt-1 flex items-center gap-1.5 text-rose-400">⚠ ${escapeHtml(t.display)}</div>`;
      if (t.hours <= SHOW_HOURS_THRESHOLD) {
        const cls = (t.hours <= 3) ? 'text-amber-400' : 'text-cyan-300';
        return `<div class="text-xs font-bold mt-1 flex items-center gap-1.5 ${cls}">⏱ ${escapeHtml(t.display)}</div>`;
      }
      return '';
    };

    return `
      <div class="card-glow ${cfg.bgCard || 'bg-slate-900/40'} ${cfg.borderCard || 'border-slate-700'} rounded-2xl p-6 backdrop-blur-xl transition-all duration-500 hover:border-blue-500/50 group relative overflow-hidden"
           style="--status-color:${cfg.color || 'var(--status-default)'}">
        <div class="status-bar"></div>
        <div class="card-content">
          <div class="flex justify-between items-start mb-5">
            <div>
              <div class="text-xs text-blue-200 font-bold uppercase tracking-wider mb-1.5">Aircraft ID</div>
              <div class="text-3xl md:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-300 to-cyan-300 tracking-tight">
                ${escapeHtml(ac.registration)}
              </div>
              <div class="text-sm text-slate-300 mt-1 font-medium">${escapeHtml(ac.type)}</div>
            </div>
            <div class="px-3.5 py-1.5 rounded-xl border ${cfg.borderCard || 'border-slate-700'} flex items-center gap-2">
              <span class="status-dot ${cfg.dotClass || 'status-default'}"></span>
              <span class="font-bold text-sm ${cfg.text || 'text-slate-300'} tracking-wide">${escapeHtml(cfg.label)}</span>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mb-5">
            <div class="bg-slate-900/40 rounded-xl p-3.5 border border-slate-800/70 hover:border-blue-500/30 transition-colors">
              <div class="text-xs text-blue-200 font-bold uppercase mb-1.5">Daily Inspection</div>
              <div class="text-lg font-bold font-mono text-slate-200">${escapeHtml(ac.dailyInsp || '')}</div>
              ${dueLine(daily)}
            </div>

            <div class="bg-slate-900/40 rounded-xl p-3.5 border border-slate-800/70 hover:border-blue-500/30 transition-colors">
              <div class="text-xs text-blue-200 font-bold uppercase mb-1.5">Weekly Inspection</div>
              <div class="text-lg font-bold font-mono text-slate-200">${escapeHtml(ac.weeklyInsp || '')}</div>
              ${dueLine(weekly)}
            </div>
          </div>

          <div class="border-t border-slate-800/50 pt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex-1">
              <div class="text-xs text-blue-200 font-bold uppercase mb-1.5">MEL Items</div>
              <div class="flex flex-wrap gap-1.5">${melChips(ac.mel)}</div>
            </div>
            <div class="flex-1 min-w-[200px]">
              <div class="text-xs text-blue-200 font-bold uppercase mb-1.5">Operational Status</div>
              <div class="text-sm font-medium min-h-[24px]">${alertHTML}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function tableHTML(list) {
    const rows = list.map(ac => {
      const statusKey = (ac.status || 'DEFAULT').toUpperCase();
      const cfg = STATUS_CONFIG[statusKey] || STATUS_CONFIG.DEFAULT;
      const daily = calculateTime(ac.dailyInsp);
      const weekly = calculateTime(ac.weeklyInsp);

      const timeCell = (t) => {
        if (t.hours === 999) return '';
        if (t.overdue) return `<span class="text-rose-400 font-bold">${escapeHtml(t.display)}</span>`;
        if (t.hours <= 3) return `<span class="text-amber-400 font-bold">${escapeHtml(t.display)}</span>`;
        if (t.hours <= SHOW_HOURS_THRESHOLD) return `<span class="text-cyan-300 font-bold">${escapeHtml(t.display)}</span>`;
        return '';
      };

      return `
        <tr class="border-b border-slate-800/60 hover:bg-slate-900/40">
          <td class="py-3 px-3 text-slate-400 font-mono">${ac.slNo}</td>
          <td class="py-3 px-3 font-black text-slate-100">${escapeHtml(ac.registration)}</td>
          <td class="py-3 px-3 text-slate-300">${escapeHtml(ac.type)}</td>
          <td class="py-3 px-3">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-xl border ${cfg.borderCard || 'border-slate-700'} ${cfg.text || 'text-slate-300'}">
              <span class="status-dot ${cfg.dotClass || 'status-default'}"></span>
              <span class="font-bold text-sm">${escapeHtml(cfg.label)}</span>
            </span>
          </td>
          <td class="py-3 px-3 font-mono text-slate-200">${escapeHtml(ac.dailyInsp || '')}<div class="text-xs mt-1">${timeCell(daily)}</div></td>
          <td class="py-3 px-3 font-mono text-slate-200">${escapeHtml(ac.weeklyInsp || '')}<div class="text-xs mt-1">${timeCell(weekly)}</div></td>
          <td class="py-3 px-3">${melChips(ac.mel)}</td>
          <td class="py-3 px-3 text-slate-300 max-w-[360px] truncate" title="${escapeHtml(ac.remarks || '')}">${escapeHtml(ac.remarks || '')}</td>
        </tr>
      `;
    }).join('');

    return `
      <div class="mobile-scroll">
        <table class="min-w-table w-full text-left border-collapse rounded-2xl overflow-hidden">
          <thead class="table-header-sticky">
            <tr class="text-xs text-blue-200 uppercase tracking-widest">
              <th class="py-3 px-3">Sl</th>
              <th class="py-3 px-3">Registration</th>
              <th class="py-3 px-3">Type</th>
              <th class="py-3 px-3">Status</th>
              <th class="py-3 px-3">Daily Insp</th>
              <th class="py-3 px-3">Weekly Insp</th>
              <th class="py-3 px-3">MEL</th>
              <th class="py-3 px-3">Remarks</th>
            </tr>
          </thead>
          <tbody class="bg-slate-950/40">
            ${rows || `<tr><td class="py-6 px-3 text-slate-400" colspan="8">No aircraft in this view.</td></tr>`}
          </tbody>
        </table>
      </div>
    `;
  }

  function render() {
    const list = filteredList();

    if (viewMode === 'grid') {
      content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
          ${list.map(cardHTML).join('') || `<div class="text-slate-400">No aircraft in this view.</div>`}
        </div>
      `;
    } else {
      content.innerHTML = tableHTML(list);
    }

    // update countdown text
    countdown.textContent = `${nextSync}s`;
  }

  async function syncNow() {
    if (syncing) return;
    syncing = true;
    btnSync.disabled = true;
    btnSync.classList.add('opacity-60', 'cursor-not-allowed');

    setSystem('syncing', 'SYNCHRONIZING DATA...');
    setError(null);

    try {
      const csvText = await window.fetchGoogleSheet(SHEET_URL);
      const parsed = parseCSV(csvText);
      if (!parsed.length) throw new Error('No valid aircraft data found');

      aircraft = parsed;
      lastSyncTime = new Date();
      updateLastSync();
      setSystem('operational', 'ALL SYSTEMS OPERATIONAL');
    } catch (e) {
      console.error(e);
      setError(e.message || 'Data source unavailable');

      // Fallback: keep existing list; if none, inject demo minimal
      if (!aircraft.length) {
        aircraft = [
          {slNo:1,registration:"VT-DEMO",type:"A320",status:"SERVICEABLE",dailyInsp:"25/01/2026 14:30",weeklyInsp:"01/02/2026 09:00",mel:"",remarks:"Demo Mode"},
          {slNo:2,registration:"VT-TEST",type:"B737",status:"MRO",dailyInsp:"20/01/2026 10:00",weeklyInsp:"28/01/2026 16:00",mel:"Hydraulic leak",remarks:"Under maintenance"},
          {slNo:3,registration:"VT-FAULT",type:"A321",status:"AOG",dailyInsp:"18/01/2026 08:00",weeklyInsp:"25/01/2026 11:00",mel:"Engine fault",remarks:"Critical repair"}
        ];
      }
    } finally {
      syncing = false;
      btnSync.disabled = false;
      btnSync.classList.remove('opacity-60', 'cursor-not-allowed');
      render();
    }
  }

  // ===== Wire up UI
  btnGrid.addEventListener('click', () => setView('grid'));
  btnTable.addEventListener('click', () => setView('table'));
  btnSync.addEventListener('click', async () => {
    nextSync = REFRESH_SECONDS;
    await syncNow();
  });

  // ===== Init
  buildFilters();
  tickClock();
  setSystem('initializing', 'SYSTEM INITIALIZING');
  render();
  syncNow();

  // ===== Timers
  setInterval(tickClock, 1000);

  setInterval(() => {
    nextSync -= 1;
    if (nextSync <= 0) {
      nextSync = REFRESH_SECONDS;
      syncNow();
    } else {
      // re-render only for countdown + time remaining display update
      render();
    }
  }, 1000);
</script>
</body>
</html>
